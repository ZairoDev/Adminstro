name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        command_timeout: 30m
        script: |
          set -e
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Starting Deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          cd /var/www/adminstro
          
          echo "ğŸ“¦ Pulling latest code..."
          git pull origin main
          
          echo "ğŸ“¦ Installing dependencies..."
          npm install
          
          echo "ğŸ—ï¸ Building application..."
          sudo rm -rf .next
          sudo chown -R jenkins:jenkins /var/www/adminstro
          npm run build
          
          if [ ! -d ".next" ]; then
            echo "âŒ Build failed!"
            exit 1
          fi
          echo "âœ… Build successful"
          
          echo "ğŸ”„ Restarting application..."
          pm2 delete adminstro 2>/dev/null || true
          pm2 start npm --name adminstro -- start
          pm2 save
          
          echo "ğŸ¥ Health check..."
          sleep 10
          
          if pm2 describe adminstro | grep -q "status.*online"; then
            echo "âœ… Deployment successful!"
            pm2 list
          else
            echo "âŒ Deployment failed!"
            pm2 logs adminstro --lines 50
            exit 1
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
