name: Deploy to VPS (Zero-Downtime)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        command_timeout: 30m
        script: |
          set -e
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Starting Zero-Downtime Deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Configuration
          DEPLOY_DIR="/var/www/adminstro"
          NEW_BUILD_DIR="/var/www/adminstro_new_build"
          BACKUP_DIR="/var/www/adminstro_rollback_$(date +%Y%m%d_%H%M%S)"
          PM2_APP_NAME="adminstro"
          
          echo "ğŸ“Š Current application status:"
          pm2 describe ${PM2_APP_NAME} | grep -E "status|uptime|restarts" || echo "App not running"
          
          # Step 1: Create backup of current working version
          echo ""
          echo "ğŸ’¾ Creating backup of current version..."
          if [ -d "${DEPLOY_DIR}/.next" ]; then
            sudo mkdir -p ${BACKUP_DIR}
            sudo cp -r ${DEPLOY_DIR}/.next ${BACKUP_DIR}/
            sudo cp ${DEPLOY_DIR}/package.json ${BACKUP_DIR}/ 2>/dev/null || true
            sudo cp ${DEPLOY_DIR}/package-lock.json ${BACKUP_DIR}/ 2>/dev/null || true
            sudo chown -R jenkins:jenkins ${BACKUP_DIR}
            echo "âœ… Backup created at: ${BACKUP_DIR}"
            echo ${BACKUP_DIR} > /tmp/last_backup_path.txt
          else
            echo "âš ï¸ No previous build to backup"
          fi
          
          # Step 2: Prepare new build directory
          echo ""
          echo "ğŸ“ Preparing new build directory..."
          sudo rm -rf ${NEW_BUILD_DIR}
          sudo mkdir -p ${NEW_BUILD_DIR}
          sudo chown -R jenkins:jenkins ${NEW_BUILD_DIR}
          
          # Clone repository to new directory
          echo "ğŸ“¦ Cloning repository..."
          cd ${NEW_BUILD_DIR}
          git clone --depth 1 --branch main https://github.com/ZairoDev/Adminstro.git .
          
          # Fix permissions after git clone
          sudo chown -R jenkins:jenkins ${NEW_BUILD_DIR}
          
          # Copy environment files from current deployment
          echo "ğŸ”§ Copying environment files..."
          if [ -f "${DEPLOY_DIR}/.env.production" ]; then
            cp ${DEPLOY_DIR}/.env.production ${NEW_BUILD_DIR}/.env.production
            chmod 600 ${NEW_BUILD_DIR}/.env.production
            echo "âœ… Copied .env.production"
          else
            echo "âš ï¸ WARNING: No .env.production found!"
          fi
          
          if [ -f "${DEPLOY_DIR}/.env.local" ]; then
            cp ${DEPLOY_DIR}/.env.local ${NEW_BUILD_DIR}/.env.local
            chmod 600 ${NEW_BUILD_DIR}/.env.local
            echo "âœ… Copied .env.local"
          elif [ -f "${DEPLOY_DIR}/.env.production" ]; then
            cp ${DEPLOY_DIR}/.env.production ${NEW_BUILD_DIR}/.env.local
            chmod 600 ${NEW_BUILD_DIR}/.env.local
            echo "âœ… Created .env.local from .env.production"
          fi
          
          # Step 3: Install dependencies in new directory
          echo ""
          echo "ğŸ“¦ Installing dependencies in new build..."
          cd ${NEW_BUILD_DIR}
          
          # Ensure we have write permissions
          sudo chown -R jenkins:jenkins ${NEW_BUILD_DIR}
          
          npm install
          
          if [ $? -ne 0 ]; then
            echo "âŒ npm install failed!"
            echo "ğŸ”„ Current application is still running (unchanged)"
            sudo rm -rf ${NEW_BUILD_DIR}
            exit 1
          fi
          echo "âœ… Dependencies installed"
          
          # Step 4: Build application in new directory
          echo ""
          echo "ğŸ—ï¸ Building application in new directory..."
          
          # Remove any old .next directory
          sudo rm -rf .next
          
          npm run build
          
          BUILD_EXIT_CODE=$?
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ Build failed with exit code ${BUILD_EXIT_CODE}"
            echo "ğŸ”„ Current application is still running (unchanged)"
            sudo rm -rf ${NEW_BUILD_DIR}
            exit 1
          fi
          
          # Verify build output
          if [ ! -d "${NEW_BUILD_DIR}/.next" ]; then
            echo "âŒ Build failed - .next directory not created"
            echo "ğŸ”„ Current application is still running (unchanged)"
            sudo rm -rf ${NEW_BUILD_DIR}
            exit 1
          fi
          
          # Fix permissions on build output
          sudo chown -R jenkins:jenkins ${NEW_BUILD_DIR}
          
          echo "âœ… Build completed successfully"
          echo "Build size: $(du -sh ${NEW_BUILD_DIR}/.next | cut -f1)"
          
          # Step 5: Atomic swap - replace old with new
          echo ""
          echo "ğŸ”„ Swapping to new build (atomic operation)..."
          
          # Stop PM2
          pm2 delete ${PM2_APP_NAME} 2>/dev/null || true
          
          # Quick atomic swap with sudo
          TEMP_OLD="${DEPLOY_DIR}_old_temp"
          sudo mv ${DEPLOY_DIR} ${TEMP_OLD}
          sudo mv ${NEW_BUILD_DIR} ${DEPLOY_DIR}
          
          # Fix permissions on new deployment
          sudo chown -R jenkins:jenkins ${DEPLOY_DIR}
          
          # Start PM2 with new build
          echo "ğŸš€ Starting new version..."
          cd ${DEPLOY_DIR}
          pm2 start npm --name ${PM2_APP_NAME} -- start
          pm2 save
          
          # Step 6: Health check on new version
          echo ""
          echo "ğŸ¥ Running health check on new version..."
          sleep 15
          
          HEALTH_CHECK_PASSED=false
          
          if pm2 describe ${PM2_APP_NAME} | grep -q "status.*online"; then
            echo "âœ… PM2 status: ONLINE"
            
            # Check restart count
            RESTARTS=$(pm2 describe ${PM2_APP_NAME} | grep 'restarts' | awk '{print $NF}' | tr -d 'â”‚' | xargs || echo "0")
            echo "Restart count: ${RESTARTS}"
            
            if [ "$RESTARTS" -lt 3 ]; then
              HEALTH_CHECK_PASSED=true
            else
              echo "âš ï¸ Too many restarts detected"
            fi
          else
            echo "âŒ Application is not online"
          fi
          
          # Step 7: Rollback if health check failed
          if [ "$HEALTH_CHECK_PASSED" = false ]; then
            echo ""
            echo "âŒ HEALTH CHECK FAILED - ROLLING BACK!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            pm2 delete ${PM2_APP_NAME} 2>/dev/null || true
            
            # Restore old version with sudo
            sudo rm -rf ${DEPLOY_DIR}
            sudo mv ${TEMP_OLD} ${DEPLOY_DIR}
            sudo chown -R jenkins:jenkins ${DEPLOY_DIR}
            
            # Restart old version
            cd ${DEPLOY_DIR}
            pm2 start npm --name ${PM2_APP_NAME} -- start
            pm2 save
            
            sleep 10
            
            echo ""
            echo "ğŸ”„ Rollback completed - old version restored"
            pm2 list
            
            echo ""
            echo "Failed deployment logs:"
            pm2 logs ${PM2_APP_NAME} --lines 50
            
            exit 1
          fi
          
          # Step 8: Success - cleanup old version
          echo ""
          echo "âœ… Health check passed - cleaning up..."
          sudo rm -rf ${TEMP_OLD}
          
          # Keep only last 5 rollback backups
          cd /var/www
          ls -t adminstro_rollback_* 2>/dev/null | tail -n +6 | xargs -r sudo rm -rf
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "New version is live and healthy"
          echo ""
          pm2 list
          echo ""
          echo "Recent logs:"
          pm2 logs ${PM2_APP_NAME} --nostream --lines 15
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
