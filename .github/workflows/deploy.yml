name: Deploy to VPS (Zero-Downtime)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ๐ Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        command_timeout: 30m
        script: |
          set -e
          
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Starting Zero-Downtime Deployment"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          
          DEPLOY_DIR="/var/www/adminstro"
          NEW_BUILD_DIR="/var/www/adminstro_new_build"
          BACKUP_DIR="/var/www/adminstro_rollback_$(date +%Y%m%d_%H%M%S)"
          PM2_APP_NAME="adminstro"
          
          echo "๐ Current status:"
          pm2 list | grep ${PM2_APP_NAME} || echo "App not running"
          
          # Backup
          echo ""
          echo "๐พ Backing up..."
          if [ -d "${DEPLOY_DIR}/.next" ]; then
            sudo mkdir -p ${BACKUP_DIR}
            sudo cp -r ${DEPLOY_DIR}/.next ${DEPLOY_DIR}/package*.json ${BACKUP_DIR}/ 2>/dev/null || true
            sudo chown -R jenkins:jenkins ${BACKUP_DIR}
            echo "โ Backup created"
          fi
          
          # New build
          echo ""
          echo "๐ Preparing new build..."
          sudo rm -rf ${NEW_BUILD_DIR}
          sudo mkdir -p ${NEW_BUILD_DIR}
          sudo chown -R jenkins:jenkins ${NEW_BUILD_DIR}
          
          cd ${NEW_BUILD_DIR}
          git clone --depth 1 --branch main https://github.com/ZairoDev/Adminstro.git .
          sudo chown -R jenkins:jenkins ${NEW_BUILD_DIR}
          
          # Copy env
          [ -f "${DEPLOY_DIR}/.env.production" ] && cp ${DEPLOY_DIR}/.env.production .
          [ -f "${DEPLOY_DIR}/.env.local" ] && cp ${DEPLOY_DIR}/.env.local .
          [ ! -f ".env.local" ] && [ -f ".env.production" ] && cp .env.production .env.local
          
          # Install
          echo ""
          echo "๐ฆ Installing..."
          npm install || { echo "โ Install failed"; sudo rm -rf ${NEW_BUILD_DIR}; exit 1; }
          
          # Build
          echo ""
          echo "๐๏ธ Building..."
          sudo rm -rf .next
          npm run build || { echo "โ Build failed"; sudo rm -rf ${NEW_BUILD_DIR}; exit 1; }
          
          [ ! -d ".next" ] && { echo "โ No .next"; sudo rm -rf ${NEW_BUILD_DIR}; exit 1; }
          
          sudo chown -R jenkins:jenkins ${NEW_BUILD_DIR}
          echo "โ Build: $(du -sh .next | cut -f1)"
          
          # Swap
          echo ""
          echo "๐ Swapping..."
          pm2 delete ${PM2_APP_NAME} 2>/dev/null || true
          
          TEMP_OLD="${DEPLOY_DIR}_old"
          sudo mv ${DEPLOY_DIR} ${TEMP_OLD}
          sudo mv ${NEW_BUILD_DIR} ${DEPLOY_DIR}
          sudo chown -R jenkins:jenkins ${DEPLOY_DIR}
          
          cd ${DEPLOY_DIR}
          pm2 start npm --name ${PM2_APP_NAME} --update-env -- start
          pm2 save
          
          # Health check
          echo ""
          echo "๐ฅ Health check..."
          sleep 15
          
          HEALTH_OK=false
          
          if pm2 describe ${PM2_APP_NAME} | grep -q "status.*online"; then
            sleep 10
            if pm2 describe ${PM2_APP_NAME} | grep -q "status.*online"; then
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
              if [ "$HTTP_CODE" != "000" ]; then
                HEALTH_OK=true
              fi
            fi
          fi
          
          # Rollback if needed
          if [ "$HEALTH_OK" = false ]; then
            echo "โ ROLLING BACK"
            pm2 delete ${PM2_APP_NAME} 2>/dev/null || true
            sudo rm -rf ${DEPLOY_DIR}
            sudo mv ${TEMP_OLD} ${DEPLOY_DIR}
            sudo chown -R jenkins:jenkins ${DEPLOY_DIR}
            cd ${DEPLOY_DIR}
            pm2 start npm --name ${PM2_APP_NAME} -- start
            pm2 save
            echo "๐ Rollback done"
            exit 1
          fi
          
          # Success
          echo ""
          echo "โ Cleaning up..."
          sudo rm -rf ${TEMP_OLD}
          cd /var/www && ls -t adminstro_rollback_* 2>/dev/null | tail -n +6 | xargs -r sudo rm -rf

          # Cleanup old backups (keep last 5)
          echo "๐งน Removing old rollback backups (keeping last 5)..."
          cd /var/www

          ls -dt adminstro_rollback_* 2>/dev/null | tail -n +6 | while read dir; do
            echo "๐๏ธ Removing backup: $dir"
            rm -rf "$dir"
          done

          echo "โ Backup cleanup complete"
          
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ DEPLOYMENT SUCCESSFUL!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "Time: $(date)"
          echo "Status: ONLINE โ"
          echo ""
          pm2 list
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
